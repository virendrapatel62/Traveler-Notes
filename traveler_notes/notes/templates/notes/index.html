<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <style>
        html,
        body,
        #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>


    <!-- Note Model Start  -->
    <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title display-4" id="exampleModalLabel">Add New Note</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- form start  -->
                <form method="post" id='noteForm'>
                    <!-- model Body -->
                    <div class="modal-body">

                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input required type="text" class="form-control" id="title" placeholder="I Liked Hotel ABC">
                        </div>
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comments</label>
                            <textarea required class="form-control" id="comment" rows="4"></textarea>
                        </div>


                    </div>
                    <!-- model Body End  -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <input type="submit" class="btn btn-primary" value="Create Note">

                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Model end  -->



</body>

<!-- Map Javascript -->
<script src="https://apis.mapmyindia.com/advancedmaps/v1/4co9h19opazwpeulj4b28t8dfuwh7ykm/map_load?v=1.3"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous"></script>

<script>
    var map;
    var noteModalHtmlElement;
    var noteModal
    var title, comment, lat, lng
    var form

    var createNoteApi = '/api/notes'
    var getNotesApi = '/api/notes'

    window.onload = () => {
        console.log("On Load Function")
        initializeMap()
        handleMapClick()
        modalSetup()
        handleNoteFormSubmission()
        getAllNotes()
    }

    function getAllNotes() {
        $.ajax({
            type: "GET",
            url: getNotesApi,
            success: function (notes) {
                console.log({ notes });
                for (let index = 0; index < notes.length; index++) {
                    const note = notes[index]
                    addMarker(note.lat, note.lng)
                }
            }
        });
    }


    function afterSaveNote(data) {
        console.log({ data });


        addMarker(data.lat, data.lng)
        noteModal.hide()
        form.reset()
    }

    function addMarker(lat, lng) {
        // add marker 
        const marker = L.marker([lat, lng]).addTo(map);

        marker.on('click', event => {
            console.log(event);
            const lat = event.latlng.lat
            const lng = event.latlng.lng
            console.log({ lat, lng });
        })

    }

    function saveNote() {
        const data = { lat, lng, title, comment, csrfmiddlewaretoken: '{{csrf_token}}' }
        $.ajax({
            type: "POST",
            url: createNoteApi,
            data: data,
            success: afterSaveNote
        });
    }

    function handleNoteFormSubmission() {
        form = document.getElementById('noteForm')
        // handling form submission
        form.onsubmit = (event) => {

            event.preventDefault()
            const { title: titleInput, comment: commentInput } = form.elements

            title = titleInput.value
            comment = commentInput.value
            saveNote()
        }
    }

    function modalSetup() {
        console.log("Doing Modal Setup")
        noteModalHtmlElement = document.getElementById('noteModal')
        noteModal = new bootstrap.Modal(noteModalHtmlElement)

    }


    function initializeMap() {
        console.log("Initialize Map Function")
        map = new MapmyIndia.Map(
            "map",
            {
                center: [20.5937, 78.9629],
                zoomControl: true,
                zoom: 5,
                hybrid: true
            }
        );
    }

    function handleMapClick() {
        console.log("Hanlde map click Setup")

        map.on('click', (event) => {
            const { latlng } = event

            lat = latlng.lat
            lng = latlng.lng
            noteModal.show()
        })
    }



</script>

</html>